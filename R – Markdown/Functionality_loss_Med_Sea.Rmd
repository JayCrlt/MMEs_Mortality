---
title: "Traits loss in the Mediterranean Sea"
author: "J√©r√©my Carlot (R Analysis - Functional part)"
date: "2023-02-27"
output: html_document
bibliography: Bibliography/Bibliography.bib
link-citations: true
fig-captions: yes
csl: Bibliography/nature.csl
---

```{=html}
<style type="text/css">
.main-container {
  max-width: 700px;
  margin-left: auto;
  margin-right: auto}
body {
  text-align: justify}
</style>
```
## Highlights

1.  Disproportionate collection effort information with¬†*Pinna nobilis*¬†(27% of the whole dataset representing 569 mortality records). Almost all mortality records accounting for¬†*P. nobilis*¬†are considered severe (i.e., 91%) and 49% of the severe mortality records (i.e., 517 observations) focused on¬†*P. nobilis*.

2.  The MMEs have impaired a total of 137 benthic species. It represents, in terms of functional entities, not less than 91 groups of species. Some traits regarding 11 species still need to be clarified. 21 FEs correspond to at least two species; 70 FEs are single-species groups.

3.  The amount of FEs affected within a 1¬∞ cell is spatially sparse.

4.  Species being/having

    1.  massive--erect form,

    2.  solitary behaviour,

    3.  a very high longevity,

    4.  very big,

    5.  heterotrophs,

    6.  filters-feeders consumers,

    7.  slow-growing,

    8.  calcifying,

    9.  sessile and

    10. non-carbon storing were the most impaired by the MMEs during the last decades.

```{r ‚Äì Set the environment üíª , echo=FALSE, include=FALSE, warning=FALSE}
options(warn = -1)

## Packages
library(rnaturalearthdata)  
library(rnaturalearth) 
library(circlepackeR)
library(googledrive)
library(hrbrthemes) 
library(kableExtra)
library(tidyverse) 
library(data.tree)
library(ggspatial) 
library(patchwork)
library(networkD3)
library(sfheaders)
library(mapdata) 
library(leaflet) 
library(viridis) 
library(plotly)
library(readxl) 
library(scales) 
library(rgeos)
library(rgdal)
library(mFD)
library(sf) 

## Functions and shapefiles
`%notin%` <- Negate(`%in%`)
world     <- ne_countries(scale = "medium", returnclass = "sf")

## Download datasets from Google Drive
# drive_auth(email = gargle::gargle_oauth_email(),
#            scopes = "https://www.googleapis.com/auth/drive",
#            cache = gargle::gargle_oauth_cache(),
#            use_oob = gargle::gargle_oob_default())

# drive_download(file = "MED_MME_Review/functional_traits/species_traits",
#                path = "Data/species_traits", overwrite = T, type = "xlsx")
# drive_download(file = "MED_MME_Review/MME-Review data",
#                path = "Data/MME-Review data", overwrite = T, type = "xlsx")

## Load Datasets
setwd("..")
### Dataset Functional traits from Nuria Teixido et al.
species_traits <- read_excel("Data/species_traits.xlsx", 
                             sheet = "4_species_traits_clean.vcomplet", 
                             col_types = c("text", "text", "text", "text", "text", "text",
                                           "text", "text", "text", "text", "text", "text",
                                           "text", "text", "text", "text", "text"))


### Dataset Mortality from Massimo Ponti et al.
MME_Merged_data <- read_excel("Data/MME-Review data.xlsx", 
                              sheet = "Merged datasets",
                              col_types = c("numeric", "text"   , "date"   , "date"   ,
                                            "numeric", "text"   , "numeric", "text"   ,
                                            "text"   , "text"   , "text"   , "text"   ,
                                            "numeric", "numeric", "numeric", "numeric",
                                            "text"   , "text"   , "text"   , "text"   ,
                                            "numeric", "text"   , "numeric", "text"   ,
                                            "text"   , "text"   ,
                                            "text"   , "text"   , "numeric", "numeric", 
                                            "numeric", "numeric", "text"   , "numeric", 
                                            "numeric", "text"   , "text"   , "text"   ,
                                            "text"   , "text"   , "text"   , "text"   ,
                                            "text"   , "text"   , "text"   , "numeric",
                                            "numeric", "numeric", "numeric", "text"   ,
                                            "text"   , "text"   ,
                                            "text"   , "text"   , "text"   , "text"   ,
                                            "text"   , "text"   , "text"   , "text"   ,
                                            "text"   , "text"   , "text"   , "text"   ,
                                            "text"))

```

#  {.tabset}

## 1Ô∏è‚É£ Visualize raw data

```{r Figure 1, echo=FALSE, fig.fullwidth=TRUE}
## Set the leaflet parameters
mybins    <- c(1,5,10,25,50,75,80,90,100)
mypalette <- colorBin(palette="YlOrBr", 
                     domain=unique(MME_Merged_data$damaged_percentatge), 
                     na.color="transparent", 
                     bins=mybins)

## First viz all species
Figure_1 <- MME_Merged_data %>% 
leaflet() %>% 
  addTiles() %>% 
  setView(lat = 40, lng = 18 , zoom = 4) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircles(~longitude, ~latitude,  
             fillColor = ~mypalette(damaged_percentatge), 
             fillOpacity = 0.5, color = "white", radius = ~sqrt(damaged_percentatge)*3000, 
             stroke=FALSE, weight = 1,) %>%
  addLegend( pal=mypalette, values=~damaged_percentatge, opacity=0.9, 
             title = "Damaged due to MMEs (%)", 
             position = "topright" )
Figure_1
```

###### [Figure 1.]{.underline} Marine mortality records observed with percentage damage estimated across the Mediterranean Sea within the last 50 years

However, there is a huge effort focused on *Pinna nobilis* since the last decade [@basso2015; @v√°zquez-luis2017] and if we discard this information, we might observe a really different pattern about mortality events.

```{r Figure 2, echo=FALSE, fig.fullwidth=TRUE}
## First viz w/o P. nobilis
Figure_2 <- MME_Merged_data %>% filter(., species != "Pinna nobilis") %>%
leaflet() %>% 
  addTiles() %>% 
  setView(lat = 40, lng = 18 , zoom = 4) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircles(~longitude, ~latitude,  
             fillColor = ~mypalette(damaged_percentatge), 
             fillOpacity = 0.5, color = "white", radius = ~sqrt(damaged_percentatge)*3000, 
             stroke=FALSE, weight = 1,) %>%
  addLegend( pal=mypalette, values=~damaged_percentatge, opacity=0.9, 
             title = "Damaged due to MMEs (%)", 
             position = "topright" )
Figure_2
```

###### [Figure 2.]{.underline} Marine mortality records observed with percentage damage estimated across the Mediterranean Sea within the last 50 years, discarding *P. nobilis* records

## 2Ô∏è‚É£ Traits definition

In order to get a wider angle instead of quantifying traditional biodiversity loss, we defined for each species, 10 qualitative traits (see **Table 1**) to define group of species that behave the same into the Mediterranean Sea [@gomezgras_climate_2021; @teixido_functional_2018]. In other words, these group of species, called 'functional entities' @vill√©ger2011, might ensure the same group of functions into the ecosystem.

```{r analysis, echo = F}
## Define the FE number
### Be sure that we have dataset w/ mortality only
MME_Mortality      <- MME_Merged_data %>% drop_na(., damaged_percentatge)

### Look at the species into the dataset
species_MMEs       <- MME_Mortality %>% arrange(species) %>% distinct(species)
species_Fctl       <- species_traits %>% arrange(species) %>% distinct(species)

### Species mismatch
Species_mismatch   <- species_MMEs$species[species_MMEs$species %notin% species_Fctl$species]

### Remove the 4 missing species so far
MME_Mortality      <- MME_Mortality %>% filter(species %notin% Species_mismatch)

### Set up the data frames and define the FEs richness
tr_cat             <- data.frame(trait_name = colnames(species_traits[3:12]),
                                 trait_type = c("N", "N", "N", "N", "N", "N",
                                                "N", "N", "N", "N"),
                                 fuzzy_name = rep(NA, 10))
sp_tr              <- species_traits %>% column_to_rownames("species") %>% dplyr::select(., 2:11)
sp_tr              <- sp_tr %>% dplyr::mutate_all(as.factor)
sp_to_fe           <- mFD::sp.to.fe(sp_tr = sp_tr, tr_cat = tr_cat) 
fe_nm              <- unique(sp_to_fe$fe_nm) 
# length(fe_nm) # 101 FE

### List of species in each FE
fe_sp              <- list() 
for (k in fe_nm) {
  fe_sp[[k]]       <- names(sp_to_fe$sp_fe[which(sp_to_fe$sp_fe == k)]) }

### Trait values of FE
fe_tr              <- sp_to_fe$fe_tr
```

```{r table 1, echo = F}
data_sp_to_fe      <- sp_to_fe$sp_fe %>% data.frame() %>% 
  rownames_to_column(., var = "Species") %>% rename(., FE = .)
fe_tr              <- fe_tr %>% data.frame() %>% rownames_to_column(., var = "FE") 
colnames(fe_tr)    <- c("FE", "Morphology", "Coloniality", "Longevity", "Height", 
                        "Energy", "Feeding", "Growth", "Calcification", "Mobility",
                        "Storage")
table_sp_and_fe    <- inner_join(data_sp_to_fe, fe_tr, by = "FE") %>% 
  mutate(FE = recode(FE, "fe_1" = "fe_01", "fe_2" = "fe_02", "fe_3" = "fe_03", 
                     "fe_4" = "fe_04", "fe_5" = "fe_05", "fe_6" = "fe_06", 
                     "fe_7" = "fe_07", "fe_8" = "fe_08", "fe_9" = "fe_09")) %>% 
  arrange(FE)
table_sp_and_fe_up <- table_sp_and_fe %>% dplyr::filter(FE %in% c("fe_100", "fe_101"))
table_sp_and_fe_dn <- table_sp_and_fe %>% dplyr::filter(FE %notin% c("fe_100", "fe_101"))
table_sp_and_fe    <- rbind(table_sp_and_fe_dn, table_sp_and_fe_up)
table_sp_and_fe_sankey = table_sp_and_fe

# Higlight where to focus
table_sp_and_fe$Morphology = cell_spec(table_sp_and_fe$Morphology, 
                                       background = ifelse(table_sp_and_fe$Morphology == 0,
                                                      "red", "lightgrey"))
table_sp_and_fe$Coloniality = cell_spec(table_sp_and_fe$Coloniality, 
                                       background = ifelse(table_sp_and_fe$Coloniality == 0,
                                                      "red", "lightgrey"))
table_sp_and_fe$Longevity = cell_spec(table_sp_and_fe$Longevity, 
                                       background = ifelse(table_sp_and_fe$Longevity == 0,
                                                      "red", "lightgrey"))
table_sp_and_fe$Height = cell_spec(table_sp_and_fe$Height, 
                                       background = ifelse(table_sp_and_fe$Height == 0,
                                                      "red", "lightgrey"))
table_sp_and_fe$Energy = cell_spec(table_sp_and_fe$Energy, 
                                       background = ifelse(table_sp_and_fe$Energy == 0,
                                                      "red", "lightgrey"))
table_sp_and_fe$Feeding = cell_spec(table_sp_and_fe$Feeding, 
                                       background = ifelse(table_sp_and_fe$Feeding == 0,
                                                      "red", "lightgrey"))
table_sp_and_fe$Growth = cell_spec(table_sp_and_fe$Growth, 
                                       background = ifelse(table_sp_and_fe$Growth == 0,
                                                      "red", "lightgrey"))
table_sp_and_fe$Calcification = cell_spec(table_sp_and_fe$Calcification, 
                                       background = ifelse(
                                         table_sp_and_fe$Calcification == 0, 
                                         "red", "lightgrey"))
table_sp_and_fe$Mobility = cell_spec(table_sp_and_fe$Mobility, 
                                       background = ifelse(table_sp_and_fe$Mobility == 0,
                                                      "red", "lightgrey"))
table_sp_and_fe$Storage = cell_spec(table_sp_and_fe$Storage, 
                                       background = ifelse(table_sp_and_fe$Storage == 0,
                                                      "red", "lightgrey"))

table_sp_and_fe$Species[table_sp_and_fe$Species == "Haliclona (Halichoclona) fulva"] =
  "Haliclona fulva"
table_sp_and_fe$Species[table_sp_and_fe$Species == "Hymedesmia (Hymedesmia) paupertas"] =
  "Hymedesmia paupertas"

table_sp_and_fe %>% 
  kbl(escape = F) %>%
  kable_paper(full_width = F, position = "left", font_size = 11)
```

###### [Table 1.]{.underline} Functional entities parameters

Note, that here, the Functional entities `#11`, `#26`, `#29`, `#32`, `#33`, `#35`, `#67`, `#68`, `#69` and `#94` are not fully-defined yet! (i.e., presence of the code 0, synonym of *NA*)

To get more details, see this [table](https://docs.google.com/document/d/1MVJtbtWembTGE1Y3Rv9dA3lmj9zOvB298sjfcH82GLc/edit)

## 3Ô∏è‚É£ Traits impairment

In this section, we represent a global overview of the FE affected by the MMEs within the last 50 years and across the Mediterranean Sea.

```{r Figure 3 old, echo=FALSE, warn = F}

options(dplyr.summarise.inform = FALSE)

## Delineate a grid
# quantile(MME_Mortality$latitude) # 31 to 45
# quantile(MME_Mortality$longitude) # -6 to 36
Lat_grid <- seq(31, 45, 1) 
Lon_grid <- seq(-6, 36, 1)
grid     <- expand.grid(Lat_grid, Lon_grid) %>% data.frame() %>% 
  rename(Lat = Var1, Lon = Var2)

## Add FEs information into the global dataset
function_dataset   <- sp_to_fe$sp_fe %>% data.frame() %>% rownames_to_column(var = "species")
MME_Mortality_grid <- MME_Mortality %>% mutate(lon_rounded_0 = floor(longitude),
                                               lon_rounded_1 = ceiling(longitude), 
                                               lat_rounded_0 = floor(latitude), 
                                               lat_rounded_1 = ceiling(latitude)) %>% 
  inner_join(function_dataset, by = "species") %>% rename(., FEs = .)

## Extract the needed information per cell
### Convert the dataset into a sf object ‚Äì add the cell information for each row
#### Build empty vectors first
Polygon       <- vector("list", length(MME_Mortality_grid$ID_polygon))
Poly_Coord_df <- vector("list", length(MME_Mortality_grid$ID_polygon))
grid_dataset  <- vector("list", length(MME_Mortality_grid$ID_polygon))
sfc_combined  <- st_sfc()

#### Attribute a cell for each dataset row
for (i in 1:length(MME_Mortality_grid$ID_polygon)) {
  Poly_Coord_df[[i]]      <- data.frame(lon = c(MME_Mortality_grid$lon_rounded_0[i],
                                                MME_Mortality_grid$lon_rounded_1[i]), 
                                        lat = c(MME_Mortality_grid$lat_rounded_0[i],
                                                MME_Mortality_grid$lat_rounded_1[i]))
  Polygon[[i]]            <- Poly_Coord_df[[i]] %>% 
    sf::st_as_sf(coords = c("lon", "lat")) %>% st_bbox() %>% st_as_sfc()
  grid_dataset[[i]]       <- data.frame(MME_Mortality_grid[i,], Polygon[[i]]) }

#### Collect all the information into a single vector
for(i in 1:length(MME_Mortality_grid$ID_polygon)) {
  sfc_combined            <- rbind(sfc_combined, st_as_sf(Polygon[[i]])) }

#### Merge dataset with cell (sf object) information into a single document (sf object)
CRS_used = "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
grid_dataset <- st_as_sf(x = MME_Mortality_grid, coords = c("longitude", "latitude"), 
                         crs = CRS_used)
sfc_combined <- st_as_sf(x = sfc_combined, 
                         wkt = "x", 
                         crs = CRS_used)
grid_dataset <- cbind(sfc_combined, grid_dataset) %>% st_as_sf(wkt = "x")
grid_dataset <- grid_dataset %>% st_set_crs(CRS_used) %>% st_transform(crs=CRS_used)

## Extract statistics
species_affected <- grid_dataset %>% group_by(x, species) %>% summarise(occurence = n()) %>%
  group_by(x) %>% summarise(`number of taxa` = n())
FEs_affected     <- grid_dataset %>% group_by(x, FEs) %>% summarise(occurence = n()) %>%
  group_by(x) %>% summarise(`number of FEs` = n())
dammaged_cell    <- grid_dataset %>% group_by(x, species) %>% 
  summarise(dammaged = mean(damaged_percentatge)) %>% group_by(x) %>% 
  summarise(`% of damage` = mean(dammaged))

## Build the maps with 1¬∞ cells

### % of dammaged
Med_dam  <- ggplot(data = world) +
  geom_sf(data = dammaged_cell, shape = 4, aes(fill = `% of damage`), 
          col = "black", size = 5) +
  geom_sf(color = "black", fill = "light grey") +
  scale_fill_gradient(low = "white", high = "red") +
  xlab("Longitude") + ylab("Latitude") +
  coord_sf(xlim = c(-10, 40), ylim = c(30, 45), expand = FALSE) +
  ggtitle("Average percentage of damage") +
  theme(panel.grid.major = element_line(color = gray(.25), linetype = "blank", 
                                        linewidth = 0.2), 
        panel.background = element_rect(fill = "light blue"))

### Number of taxas affected
Med_spp  <- ggplot(data = world) +
  geom_sf(data = species_affected, shape = 4, aes(fill = `number of taxa`), 
          col = "black", size = 5) +
  geom_sf(color = "black", fill = "light grey") +
  scale_fill_gradient(low = "white", high = "red") +
  xlab("Longitude") + ylab("Latitude") +
  coord_sf(xlim = c(-10, 40), ylim = c(30, 45), expand = FALSE) +
  ggtitle("Number of taxa affected") +
  theme(panel.grid.major = element_line(color = gray(.25), 
                                        linetype = "blank", linewidth = 0.2),
        panel.background = element_rect(fill = "light blue"))

Col_FE_gradient_tot <- c("#ffffff", "#f1f292", "#ffdc54", "#ffa654", "#ff8c24", "#ca663a", 
                         "#ca3a3a", "#bd0909", "#88132d", "#883399", "#5f236b", "#36143d", 
                         "#1b0a1e")
Col_FE_gradient_12  <- c("#ffffff", "#f1f292", "#ffdc54", "#ffa654", "#ff8c24", "#ca663a", 
                         "#ca3a3a", "#bd0909", "#88132d", "#883399", "#5f236b", "#1b0a1e")

FEs_affected = FEs_affected %>% arrange(`number of FEs`) %>% 
  mutate(`FEs impacted` = as.factor(`number of FEs`))

### Number of FEs affected
Med_FEs  <- ggplot(data = world) +
  geom_sf(data = FEs_affected, shape = 4, aes(fill = `FEs impacted`), 
          col = "black", size = 5) +
  geom_sf(color = "black", fill = "light grey") +
  scale_fill_manual(values = Col_FE_gradient_12)+
  xlab("Longitude") + ylab("Latitude") +
  coord_sf(xlim = c(-10, 40), ylim = c(30, 45), expand = FALSE) +
  ggtitle("Number of FEs affected") +
  theme(panel.grid.major = element_line(color = gray(.25), linetype = "blank", 
                                        linewidth = 0.2), 
        panel.background = element_rect(fill = "light blue"),
        legend.position = "bottom",
        legend.text = element_text(size=8),
        legend.title = element_text(size=10),
        legend.key.size = unit(0.5, 'cm'),
        plot.margin = unit(c(-4,0,-4,0),"cm"),complete=TRUE) +
  guides(fill = guide_legend(nrow = 1))

```

```{r Figure 3 new, echo=FALSE, warn = F}

mybins    <- seq(1,13,1)
mypalette <- colorBin(palette="YlOrBr", 
                      domain=unique(FEs_affected$number.of.FEs), 
                      na.color="transparent", 
                      bins=mybins)

centroids <- FEs_affected %>% 
  st_centroid() %>% 
  # this is the crs from d, which has no EPSG code:
  st_transform(., '+proj=longlat +ellps=GRS80 +no_defs') %>%
  # since you want the centroids in a second geometry col:
  st_geometry() %>% 
  st_drop_geometry() %>% 
  st_coordinates(centroids) %>% data.frame() %>% 
  rename(Long = X, Lat = Y)

FEs_affected = cbind(FEs_affected, centroids)

Figure_3 <- FEs_affected %>% 
  leaflet() %>% 
  addTiles() %>% 
  setView(lat = 40, lng = 18 , zoom = 4) %>%
  addProviderTiles("Esri.WorldImagery") %>%
  addCircles(~Long, ~Lat,  
             fillColor = ~mypalette(number.of.FEs), 
             fillOpacity = 0.8, color = "white", stroke = F, radius = 30000) %>%
  addLegend( pal=mypalette, values=~number.of.FEs, opacity=0.9, 
             title = "Number FEs affected by MMEs", 
             position = "topright" )
Figure_3
```

###### [Figure 3.]{.underline} Number of Functional Entities (FEs) impaired during the last 50 years by the Mass Mortality Events (MMEs)

### Which species are the most affected?

One way to answer to this question is to visualize which traits are the most impacted using a Sankey diagram. In this way, we can disentangle which group or type of species were the most impaired by the previous MMEs.

```{r Figure 4, echo=FALSE, warn = F, out.extra= "100%"}
table_sp_and_fe_sankey <- table_sp_and_fe_sankey %>% rename(species = Species)
Global_dataset <- table_sp_and_fe_sankey %>% data.frame() %>% 
  inner_join(MME_Mortality, by = "species")

## Prepare the dataset to execute a Sankey Diagram
sub_data_1 <- Global_dataset %>% drop_na(damaged_qualitative) %>% 
  group_by(Morphology, damaged_qualitative) %>% 
  summarise(Occurence = n()) %>% 
  rename(Category = Morphology) %>% 
  mutate(Trait = "Morphology") %>% 
  select(Trait, Category, damaged_qualitative, Occurence)
sub_data_2 <- Global_dataset %>% drop_na(damaged_qualitative) %>% 
  group_by(Coloniality, damaged_qualitative) %>% 
  summarise(Occurence = n()) %>% 
  rename(Category = Coloniality) %>% 
  mutate(Trait = "Coloniality") %>% 
  select(Trait, Category, damaged_qualitative, Occurence)
sub_data_3 <- Global_dataset %>% drop_na(damaged_qualitative) %>% 
  group_by(Longevity, damaged_qualitative) %>% 
  summarise(Occurence = n()) %>% 
  rename(Category = Longevity) %>% 
  mutate(Trait = "Longevity") %>% 
  select(Trait, Category, damaged_qualitative, Occurence)
sub_data_4 <- Global_dataset %>% drop_na(damaged_qualitative) %>% 
  group_by(Height, damaged_qualitative) %>% 
  summarise(Occurence = n()) %>% 
  rename(Category = Height) %>% 
  mutate(Trait = "Height") %>% 
  select(Trait, Category, damaged_qualitative, Occurence)
sub_data_5 <- Global_dataset %>% drop_na(damaged_qualitative) %>% 
  group_by(Energy, damaged_qualitative) %>% 
  summarise(Occurence = n()) %>% 
  rename(Category = Energy) %>% 
  mutate(Trait = "Energy") %>% 
  select(Trait, Category, damaged_qualitative, Occurence)
sub_data_6 <- Global_dataset %>% drop_na(damaged_qualitative) %>% 
  group_by(Feeding, damaged_qualitative) %>% 
  summarise(Occurence = n()) %>% 
  rename(Category = Feeding) %>% 
  mutate(Trait = "Feeding") %>% 
  select(Trait, Category, damaged_qualitative, Occurence)
sub_data_7 <- Global_dataset %>% drop_na(damaged_qualitative) %>% 
  group_by(Growth, damaged_qualitative) %>% 
  summarise(Occurence = n()) %>% 
  rename(Category = Growth) %>% 
  mutate(Trait = "Growth") %>% 
  select(Trait, Category, damaged_qualitative, Occurence)
sub_data_8 <- Global_dataset %>% drop_na(damaged_qualitative) %>% 
  group_by(Calcification, damaged_qualitative) %>% 
  summarise(Occurence = n()) %>% 
  rename(Category = Calcification) %>% 
  mutate(Trait = "Calcification") %>% 
  select(Trait, Category, damaged_qualitative, Occurence)
sub_data_9 <- Global_dataset %>% drop_na(damaged_qualitative) %>% 
  group_by(Mobility, damaged_qualitative) %>% 
  summarise(Occurence = n()) %>% 
  rename(Category = Mobility) %>% 
  mutate(Trait = "Mobility") %>% 
  select(Trait, Category, damaged_qualitative, Occurence)
sub_data_10 <- Global_dataset %>% drop_na(damaged_qualitative) %>% 
  group_by(Storage, damaged_qualitative) %>% 
  summarise(Occurence = n()) %>% 
  rename(Category = Storage) %>% 
  mutate(Trait = "Storage") %>% 
  select(Trait, Category, damaged_qualitative, Occurence)

## Sankey dataset first node
Sankey_dataset <- rbind(sub_data_1, sub_data_2, sub_data_3, sub_data_4, sub_data_5,
                        sub_data_6, sub_data_7, sub_data_8, sub_data_9, sub_data_10) %>% 
  mutate(Occurence = round(Occurence/1548, 3)) %>% 
  mutate(Category = paste(Trait, Category, sep = "_"))  %>% 
  mutate(Category = recode(Category, "Calcification_a" = "Non-calcifying",
                                     "Calcification_b" = "Calcifying",
                                     "Coloniality_1"   = "Solitary",
                                     "Coloniality_2"   = "Colonial",
                                     "Energy_1"        = "Autotroph",
                                     "Energy_2"        = "Mixotroph",
                                     "Energy_3"        = "Heterotroph",
                                     "Feeding_a"       = "Photosynthesis",
                                     "Feeding_b"       = "Filter-feeder cilia",
                                     "Feeding_c"       = "Filter-feeder pump",
                                     "Feeding_d"       = "Filter-feeder passive",
                                     "Feeding_e"       = "Grazers",
                                     "Feeding_f"       = "Carnivores",
                                     "Feeding_g"       = "Detritivores",
                                     "Growth_1"        = "Extreme slow",
                                     "Growth_2"        = "Slow",
                                     "Growth_3"        = "Intermediate",
                                     "Growth_4"        = "Fast",
                                     "Growth_5"        = "Extreme fast",
                                     "Height_0"        = "NA",
                                     "Height_1"        = "Very small",
                                     "Height_2"        = "Small",
                                     "Height_3"        = "Medium",
                                     "Height_4"        = "Big",
                                     "Height_5"        = "Very big",
                                     "Longevity_1"     = "‚â§ 1 year",
                                     "Longevity_2"     = "]1, 5] years",
                                     "Longevity_3"     = "]5, 10] years",
                                     "Longevity_4"     = "]10, 20] years",
                                     "Longevity_5"     = "> 20 years",
                                     "Mobility_a"      = "Sessile",
                                     "Mobility_b"      = "Vagile",
                                     "Morphology_b"    = "Encrusting",
                                     "Morphology_c"    = "Filamentous",
                                     "Morphology_f"    = "Articulated",
                                     "Morphology_h"    = "Branched",
                                     "Morphology_i"    = "Massive-encrusting",
                                     "Morphology_j"    = "Massive-hemispheric",
                                     "Morphology_k"    = "Massive-erect",
                                     "Morphology_l"    = "Tree-like",
                                     "Storage_a"       = "Storing",
                                     "Storage_b"       = "Likely storing",
                                     "Storage_c"       = "Non-storing")) %>% 
  dplyr::filter(., Category != "NA")

Sankey_dataset_traits <- Sankey_dataset %>%
  group_by(Category) %>% 
  summarise(value = sum(Occurence), source = Trait) %>% 
  rename(target = Category) 
Sankey_dataset <- Sankey_dataset %>% 
  select(Category, damaged_qualitative, Occurence) %>% 
  rename(source = Category, target = damaged_qualitative, value = Occurence)
  
Sankey_dataset <- rbind(Sankey_dataset, Sankey_dataset_traits) %>% data.frame() %>%
  distinct() %>% mutate(value = value * 1548)

nodes = data.frame(name= unique(c(Sankey_dataset$source, Sankey_dataset$target)))

Sankey_dataset <- Sankey_dataset %>% 
  mutate(IDsource = match(Sankey_dataset$source, nodes$name)-1,
         IDtarget=match(Sankey_dataset$target, nodes$name)-1) %>% data.frame()

ColourScal ='d3.scaleOrdinal() 
.range(["#92D718","#92D718","#92D718","#92D718","#92D718","#92D718","#92D718","#92D718",
        "#17CA78","#17CA78",
        "#0DEAC5","#0DEAC5","#0DEAC5","#0DEAC5","#0DEAC5",
        "#0DE0EA","#0DE0EA","#0DE0EA","#0DE0EA", 
        "#08ADB5","#08ADB5","#08ADB5",
        "#086EB5","#086EB5","#086EB5","#086EB5","#086EB5",
        "#0A2EB1","#0A2EB1","#0A2EB1","#0A2EB1",
        "#1D039C","#1D039C",
        "#5B06AB","#5B06AB",
        "#850DF7","#850DF7","#850DF7",
        "#0DEAC5","#92D718","#08ADB5","#0DE0EA","#1D039C","#086EB5","#17CA78","#1D039C",
        "#850DF7","#5B06AB","#F7F30D","#F7AD0D","#F72D0D"])'

Figure_4 <- sankeyNetwork(Links = Sankey_dataset, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "value", NodeID = "name", colourScale = ColourScal , 
              sinksRight = FALSE, nodeWidth = 15, fontSize = 12, 
              nodePadding = 10, iterations = 0, width = 815, height = 700,
              margin = list(right = -120))

Figure_4
```

###### [Figure 4.]{.underline} Traits impairment according to the MMEs damage severity

Some traits are more impacted than others:

-   [**massive erects organisms**]{.underline}\
    592 occurrences with, 22 low-impacted, 21 moderate-impacted, 549 high-impacted\
    *38% from the whole dataset*

-   [**solitary organisms**]{.underline}\
    723 occurrences with, 72 low-impacted, 53 moderate-impacted, 598 high-impacted\
    *47% from the whole dataset*

-   [**very high longevity organisms**]{.underline}\
    1049 occurrences with, 222 low-impacted, 164 moderate-impacted, 663 high-impacted\
    *68% from the whole dataset*

-   [**very big organisms**]{.underline}\
    864 occurrences with, 134 low-impacted, 125 moderate-impacted, 605 high-impacted\
    *56% from the whole dataset*

-   [**heterotrophs**]{.underline}\
    1183 occurrences with, 218 low-impacted, 216 moderate-impacted, 749 high-impacted\
    *76% from the whole dataset*

-   [**filters-feeders**]{.underline} ‚ö†Ô∏è\
    1384 occurrences with, 297 low-impacted, 271 moderate-impacted, 816 high-impacted\
    *89% from the whole dataset*

-   [**slow-growing organisms**]{.underline}\
    1108 occurrences with, 219 low-impacted, 189 moderate-impacted, 700 high-impacted\
    *72% from the whole dataset*

-   [**calcifying organisms**]{.underline} ‚ö†Ô∏è\
    1408 occurrences with, 331 low-impacted, 282 moderate-impacted, 795 high-impacted\
    *91% from the whole dataset*

-   [**sessile organisms**]{.underline} ‚ö†Ô∏è\
    1500 occurrences with, 376 low-impacted, 290 moderate-impacted, 834 high-impacted\
    *97% from the whole dataset*

-   [**non-storing organisms**]{.underline} ‚ö†Ô∏è\
    1491 occurrences with, 343 low-impacted, 298 moderate-impacted, 850 high-impacted\
    *96% from the whole dataset*

Another way to look at the data, is using `Circular packing plots`. However, it will not be possible to display it into a paper.

*NB: I did not manage to upload it online.*

```{r Figure 4 alt, echo=FALSE}

# Reformat the data
Circular_Plot_dataset <- rbind(sub_data_1, sub_data_2, sub_data_3, sub_data_4, sub_data_5,
      sub_data_6, sub_data_7, sub_data_8, sub_data_9, sub_data_10) %>% 
  mutate(Category = paste(Trait, Category, sep = "_"))  %>% 
  mutate(Category = recode(Category, "Calcification_a" = "Non-calcifying",
                           "Calcification_b" = "Calcifying",
                           "Coloniality_1"   = "Solitary",
                           "Coloniality_2"   = "Colonial",
                           "Energy_1"        = "Autotroph",
                           "Energy_2"        = "Mixotroph",
                           "Energy_3"        = "Heterotroph",
                           "Feeding_a"       = "Photosynthesis",
                           "Feeding_b"       = "Filter-feeder cilia",
                           "Feeding_c"       = "Filter-feeder pump",
                           "Feeding_d"       = "Filter-feeder passive",
                           "Feeding_e"       = "Grazers",
                           "Feeding_f"       = "Carnivores",
                           "Feeding_g"       = "Detritivores",
                           "Growth_1"        = "Extreme slow",
                           "Growth_2"        = "Slow",
                           "Growth_3"        = "Intermediate",
                           "Growth_4"        = "Fast",
                           "Growth_5"        = "Extreme fast",
                           "Height_0"        = "NA",
                           "Height_1"        = "Very small",
                           "Height_2"        = "Small",
                           "Height_3"        = "Medium",
                           "Height_4"        = "Big",
                           "Height_5"        = "Very big",
                           "Longevity_1"     = "‚â§ 1 year",
                           "Longevity_2"     = "]1, 5] years",
                           "Longevity_3"     = "]5, 10] years",
                           "Longevity_4"     = "]10, 20] years",
                           "Longevity_5"     = "> 20 years",
                           "Mobility_a"      = "Sessile",
                           "Mobility_b"      = "Vagile",
                           "Morphology_b"    = "Encrusting",
                           "Morphology_c"    = "Filamentous",
                           "Morphology_f"    = "Articulated",
                           "Morphology_h"    = "Branched",
                           "Morphology_i"    = "Massive-encrusting",
                           "Morphology_j"    = "Massive-hemispheric",
                           "Morphology_k"    = "Massive-erect",
                           "Morphology_l"    = "Tree-like",
                           "Storage_a"       = "Storing",
                           "Storage_b"       = "Likely storing",
                           "Storage_c"       = "Non-storing")) %>% 
  dplyr::filter(., Category != "NA") %>% 
  dplyr::select(damaged_qualitative, Trait, Category, Occurence) %>% 
  arrange(damaged_qualitative, Trait)

# Format the data for the package circlepackeR
Circular_Plot_dataset <- data.frame(
  root = rep("root", 112),
  group = Circular_Plot_dataset$damaged_qualitative,
  subgroup = Circular_Plot_dataset$Trait,
  subsubgroup = Circular_Plot_dataset$Category,
  value = Circular_Plot_dataset$Occurence)

# Define the nodes
Circular_Plot_dataset$pathString <- paste("world", Circular_Plot_dataset$group, 
                                          Circular_Plot_dataset$subgroup, 
                                          Circular_Plot_dataset$subsubgroup, sep = "/")

Figure_4_alt <- circlepackeR(as.Node(Circular_Plot_dataset))
```

## 4Ô∏è‚É£Ô∏è Traits hypervolume

```{r Figure 5, echo = F, warn = F, message = F}

options(warn = -1)

## Split the dataset into categories
grid_dataset$damaged_qualitative[grid_dataset$damaged_qualitative == "moderate"] = "Moderate"
data_ID_Cell       <- data.frame(x = unique(paste(grid_dataset$lon_rounded_0,
                                                  grid_dataset$lon_rounded_1, 
                                                  grid_dataset$lat_rounded_0,
                                                  grid_dataset$lat_rounded_1, sep = "_")),
                                 ID_Cell = paste("Cell_",
                                                 seq(1, length(unique(grid_dataset$x)), 1),
                                                 sep = ""))
grid_dataset$rect  <- paste(grid_dataset$lon_rounded_0, grid_dataset$lon_rounded_1, 
                            grid_dataset$lat_rounded_0, grid_dataset$lat_rounded_1, sep="_")
grid_dataset       <- merge(data_ID_Cell, grid_dataset, by.x = "x", by.y = "rect")
FE_dataset         <- grid_dataset %>% 
  mutate(ID = paste(grid_dataset$ID_Cell, grid_dataset$damaged_qualitative, sep = "_"))

## Play with mortality rates
FE_matrix          <- FE_dataset %>% group_by(ID, FEs) %>% summarise(occurence = n())
FE_matrix          <- reshape2::acast(FE_matrix, ID~FEs, value.var = "occurence")

### Convert in Presence absence
FE_matrix[is.na(FE_matrix)] <- 0
FE_matrix[FE_matrix > 0]    <- 1

### computing Gower distance between FEs
tr_cat[,1] <- colnames(fe_tr)[-1]
colnames(sp_tr) <- colnames(fe_tr)[-1]
fe_tr <- fe_tr %>% column_to_rownames("FE")
fe_fe_dist <- funct.dist(fe_tr, tr_cat[,-3], metric = "gower")
fe_fspaces <- mFD::quality.fspaces(sp_dist = fe_fe_dist)

### Looking for how many axes
# print(round(fe_fspaces$quality_fspaces,3)) # > 6 dimensions
fe_6D_coord <- fe_fspaces$details_fspaces$sp_pc_coord[,1:6]

### Define the number of mortality occurences
habcat = FE_matrix %>% data.frame() %>% mutate_if(is.character,as.numeric) %>% 
  mutate(cat = sub("^[^_]*_", "", sub("^[^_]*_", "", rownames(FE_matrix)))) %>% 
  group_by(cat) %>% 
  summarise_all(sum)
FEs_cat_dataset = t(habcat) %>% data.frame() %>% janitor::row_to_names(row_number = 1) %>% 
  rownames_to_column(var = "FEs") %>% dplyr::select(-"NA")
colnames(FEs_cat_dataset) <- c("FEs", "Low_mor_occ", "Mod_mor_occ", "Sev_mor_occ") 

## Define the survival rates
grid_dataset$survival_rate <- 100 - grid_dataset$damaged_percentatge
FE_dataset         <- grid_dataset %>% 
  mutate(ID = paste(grid_dataset$ID_Cell, grid_dataset$damaged_qualitative, sep = "_"))
FE_matrix          <- FE_dataset %>% group_by(ID, FEs) %>% 
  summarise(survival_rate = mean(survival_rate))
FE_matrix          <- reshape2::acast(FE_matrix, ID~FEs, value.var = "survival_rate")

### Convert in survival rate matrix
FE_matrix[FE_matrix > 0]    <- 0
FE_matrix[is.na(FE_matrix)] <- 1

### Functional statistics
quadrats_multidimFD <- alpha.fd.multidim(sp_faxes_coord = fe_6D_coord, asb_sp_w = FE_matrix, 
                                         ind_vect = c("fdis", "fide", "fspe", "fori"), 
                                         scaling = TRUE, details_returned = TRUE, 
                                         verbose = FALSE)
quadrats_taxo_hill  <- alpha.fd.hill(asb_sp_w = FE_matrix, 
                                     sp_dist = fe_fe_dist, q = c(0,1), tau = "min",
                                     details_returned = FALSE)
colnames(quadrats_taxo_hill) <- c("FE_richness", "FE_shannon")
quadrats_funct_hill <- alpha.fd.hill(asb_sp_w = FE_matrix, sp_dist = fe_fe_dist, q = 1, 
                                     tau = "min", details_returned = FALSE)

### Merging all diversity indices with specific info
quadrats_biodiv     <- data.frame(Nb_sp = 
                                    quadrats_multidimFD$functional_diversity_indices[,1], 
                                  Impact_damage = sub("^[^_]*_", "", 
                                                      sub("^[^_]*_", "", 
                                                          rownames(quadrats_taxo_hill))),
                                  quadrats_taxo_hill, quadrats_funct_hill,
                                  quadrats_multidimFD$functional_diversity_indices[,-1]) 

### Merge PCoA coord with mortality records
pool_coord          <- quadrats_multidimFD$details$sp_faxes_coord %>% data.frame() %>%
  rownames_to_column(var = "FEs")
FEs_cat_dataset     <- merge(FEs_cat_dataset, pool_coord, by = 'FEs')

### Mortality Presence / Absence
Mortality_PA        <- FE_matrix %>% data.frame() %>% mutate_if(is.character,as.numeric) %>% 
  mutate(cat = quadrats_biodiv$Impact_damage) %>% group_by(cat) %>% 
  summarise_all(min)
Mortality_PA        <- t(Mortality_PA) %>% data.frame() %>% 
  janitor::row_to_names(row_number = 1) %>% 
  rownames_to_column(var = "FEs")

## Final dataset hypervolume
FEs_cat_dataset     <- merge(FEs_cat_dataset, Mortality_PA, by = 'FEs')

## Builds the different datasets layers for the figure
### General convex hull
conv_hull_tot = FEs_cat_dataset %>%  slice(chull(PC1, PC2))

### Low damage
FEs_cat_dataset$Low         <- as.numeric(FEs_cat_dataset$Low)
FEs_cat_dataset$Low_mor_occ <- as.numeric(FEs_cat_dataset$Low_mor_occ)
FEs_cat_dataset$Low_mor_log <- log(FEs_cat_dataset$Low_mor_occ + 1)
FEs_cat_dataset_Low_aliv    <- FEs_cat_dataset %>% filter(Low >  0) %>% 
  dplyr::select(-c(Moderate, Severe, Mod_mor_occ, Sev_mor_occ)) 
FEs_cat_dataset_Low_dead    <- FEs_cat_dataset %>% filter(Low == 0) %>% 
  dplyr::select(-c(Moderate, Severe, Mod_mor_occ, Sev_mor_occ))
conv_hull_low               <- FEs_cat_dataset_Low_aliv %>% slice(chull(PC1, PC2))

### Moderate damage
FEs_cat_dataset$Moderate    <- as.numeric(FEs_cat_dataset$Moderate)
FEs_cat_dataset$Mod_mor_occ <- as.numeric(FEs_cat_dataset$Sev_mor_occ)
FEs_cat_dataset$Mod_mor_log <- log(FEs_cat_dataset$Mod_mor_occ + 1)
FEs_cat_dataset_Mod_aliv    <- FEs_cat_dataset %>% filter(Moderate >  0) %>% 
  dplyr::select(-c(Low, Severe, Low_mor_occ, Sev_mor_occ)) 
FEs_cat_dataset_Mod_dead    <- FEs_cat_dataset %>% filter(Moderate == 0) %>% 
  dplyr::select(-c(Low, Severe, Low_mor_occ, Sev_mor_occ))
conv_hull_mod               <- FEs_cat_dataset_Mod_aliv %>% slice(chull(PC1, PC2))

### Moderate damage
FEs_cat_dataset$Severe      <- as.numeric(FEs_cat_dataset$Severe)
FEs_cat_dataset$Sev_mor_occ <- as.numeric(FEs_cat_dataset$Low_mor_occ)
FEs_cat_dataset$Sev_mor_log <- log(FEs_cat_dataset$Sev_mor_occ + 1)
FEs_cat_dataset_Sev_aliv    <- FEs_cat_dataset %>% filter(Severe >  0) %>% 
  dplyr::select(-c(Low, Moderate, Low_mor_occ, Mod_mor_occ)) 
FEs_cat_dataset_Sev_dead    <- FEs_cat_dataset %>% filter(Severe == 0) %>% 
  dplyr::select(-c(Low, Moderate, Low_mor_occ, Mod_mor_occ))
conv_hull_sev               <- FEs_cat_dataset_Sev_aliv %>% slice(chull(PC1, PC2))

### Hypervolume Figure

Low_hypervolume <- ggplot(data = conv_hull_tot, aes(x = PC1, y = PC2)) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf), 
            fill = "#deebf7", color = "NA", alpha = 0.5, inherit.aes = F) +
  geom_polygon(alpha = .8, col = "black", fill = "white") +
  geom_polygon(data = conv_hull_low, aes(x = PC1, y = PC2), 
               alpha = .5, col = "black", fill = "yellow") +
  geom_point(data = FEs_cat_dataset_Low_aliv, aes(x = PC1, y = PC2, group = FEs), 
             col = "black", fill = "yellow", size = 3, shape = 21) +
  geom_point(data = FEs_cat_dataset_Low_dead, aes(x = PC1, y = PC2, size = Low_mor_occ, 
                                                  group = FEs), 
             col = "black", fill = "grey", shape = 21, alpha = .4) +
  theme_minimal() + 
  scale_size_continuous(range = c(min(FEs_cat_dataset_Low_dead$Low_mor_log) + 1, 
                                  max(FEs_cat_dataset_Low_dead$Low_mor_log) + 1)) + 
  theme(legend.position = "none") + ggtitle("Low damage (<30%)")

Mod_hypervolume <- ggplot(data = conv_hull_tot, aes(x = PC1, y = PC2)) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf), 
            fill = "#deebf7", color = "NA", alpha = 0.5, inherit.aes = F) +
  geom_polygon(alpha = .8, col = "black", fill = "white") +
  geom_polygon(data = conv_hull_mod, aes(x = PC1, y = PC2), 
               alpha = .5, col = "black", fill = "orange") +
  geom_point(data = FEs_cat_dataset_Mod_aliv, aes(x = PC1, y = PC2, group = FEs), 
             col = "black", fill = "orange", size = 3, shape = 21) +
  geom_point(data = FEs_cat_dataset_Mod_dead, aes(x = PC1, y = PC2, size = Mod_mor_occ, 
                                                  group = FEs), 
             col = "black", fill = "grey", shape = 21, alpha = .4) +
  theme_minimal() + 
  scale_size_continuous(range = c(min(FEs_cat_dataset_Mod_dead$Mod_mor_log) + 1, 
                                  max(FEs_cat_dataset_Mod_dead$Mod_mor_log) + 1)) + 
  theme(legend.position = "none") + ggtitle("Moderate damage (>30% and <60%)")

Sev_hypervolume <- ggplot(data = conv_hull_tot, aes(x = PC1, y = PC2)) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf), 
            fill = "#deebf7", color = "NA", alpha = 0.5, inherit.aes = F) +
  geom_polygon(alpha = .8, col = "black", fill = "white") +
  geom_polygon(data = conv_hull_sev, aes(x = PC1, y = PC2), 
               alpha = .5, col = "black", fill = "red") +
  geom_point(data = FEs_cat_dataset_Sev_aliv, aes(x = PC1, y = PC2, group = FEs), 
             col = "black", fill = "red", size = 3, shape = 21) +
  geom_point(data = FEs_cat_dataset_Sev_dead, aes(x = PC1, y = PC2, size = Sev_mor_occ, 
                                                  group = FEs), 
             col = "black", fill = "grey", shape = 21, alpha = .4) +
  theme_minimal() + 
  scale_size_continuous(range = c(min(FEs_cat_dataset_Sev_dead$Sev_mor_log) + 1, 
                                  max(FEs_cat_dataset_Sev_dead$Sev_mor_log) + 1)) + 
  theme(legend.position = "none") + ggtitle("High damage (>60%)")

Figure_5 = Low_hypervolume + Mod_hypervolume + Sev_hypervolume +
  plot_annotation(caption = 'Note: the light grey dots represent affected FEs while colored dots represents non-affected FEs')

ggplotly(Low_hypervolume) %>% layout(hovermode ='FEs')
ggplotly(Mod_hypervolume) %>% layout(hovermode ='FEs')
ggplotly(Sev_hypervolume) %>% layout(hovermode ='FEs')
```

## References
